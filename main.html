<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo.js - JavaScript Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <style>
        body {
            font-family: "Courier New", Courier, monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            align-items: center;
            background-color: #000;
            color: #fff;
        }
        #container {
            width: 80%;
            max-width: 800px;
            background-color: #000;
            border: 1px solid #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }
        #editor {
            height: 300px; /* Increased height for more code */
            border-bottom: 1px solid #333;
            padding: 10px;
            overflow: auto;
            background-color: #000;
            color: #fff;
            font-size: 14px; /* Slightly larger font size for better readability */
        }
        #console {
            height: 150px;
            border-bottom: 1px solid #333;
            padding: 10px;
            overflow: auto;
            background-color: #000;
            color: #fff;
        }
        #commandInputContainer {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #commandInput {
            padding: 5px;
            width: calc(100% - 90px);
            background-color: #111;
            color: #fff;
            border: 1px solid #333;
        }
        button {
            padding: 5px 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #333;
            cursor: pointer;
        }
        button:hover {
            background-color: #555;
        }
        .error {
            color: #ff4d4d;
        }
        .warn {
            color: #ffcc00;
        }
        .log {
            color: #00ff00;
        }
        .hljs {
            background: none;
        }
        .label {
            margin-bottom: 5px;
            font-size: 0.8em;
            color: #666;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #111;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #333;
            width: 80%;
        }
        .close {
            color: #f1f1f1;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        #fileList {
            margin-bottom: 10px;
        }
        #fileList li {
            list-style-type: none;
            margin: 5px 0;
        }
        #fileList li button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div>
            <div class="label">Script Input Area</div>
            <div id="editor" contenteditable="true" style="padding: 10px;"></div>
        </div>
        <div>
            <div class="label">Console Output Area</div>
            <div id="console" style="padding: 10px;"></div>
        </div>
        <div id="commandInputContainer">
            <input type="text" id="commandInput" placeholder="Enter command...">
            <button onclick="executeCommand()">Run</button>
        </div>
        <div style="padding: 10px;">
            <button onclick="executeEditorScript()">Run Script</button>
            <button id="autoScrollToggle" onclick="toggleAutoScroll()">Disable Auto Scroll</button>
            <button id="openFileManager" onclick="openFileManager()">File Manager</button>
        </div>
    </div>

    <!-- 文件管理器浮窗 -->
    <div id="fileManagerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFileManager()">&times;</span>
            <h2>File Manager</h2>
            <div id="fileList"></div>
            <button onclick="openCreateFileModal()">Create New File</button>
            <button onclick="openCreateFolderModal()">Create New Folder</button>
            <div id="createFileModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeCreateFileModal()">&times;</span>
                    <h3>Create New File</h3>
                    <input type="text" id="newFileName" placeholder="File Name">
                    <textarea id="newFileContent" placeholder="File Content"></textarea>
                    <button onclick="createFile()">Save</button>
                </div>
            </div>
            <div id="createFolderModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeCreateFolderModal()">&times;</span>
                    <h3>Create New Folder</h3>
                    <input type="text" id="newFolderName" placeholder="Folder Name">
                    <button onclick="createFolder()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        const editor = document.getElementById('editor');
        const consoleOutput = document.getElementById('console');
        const commandInput = document.getElementById('commandInput');
        const autoScrollToggle = document.getElementById('autoScrollToggle');
        const fileManagerModal = document.getElementById('fileManagerModal');
        const createFileModal = document.getElementById('createFileModal');
        const createFolderModal = document.getElementById('createFolderModal');
        let autoScrollEnabled = true;

        // Initialize highlight.js
        hljs.highlightAll();

        // Redirect console methods to our console output
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            const output = args.join(' ');
            consoleOutput.innerHTML += `<p class="log">${output}</p>`;
            if (autoScrollEnabled) {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            originalConsoleLog(...args); // Optionally log to the original console
        };

        console.error = function(...args) {
            const output = args.join(' ');
            consoleOutput.innerHTML += `<p class="error">${output}</p>`;
            if (autoScrollEnabled) {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            originalConsoleError(...args); // Optionally log to the original console
        };

        console.warn = function(...args) {
            const output = args.join(' ');
            consoleOutput.innerHTML += `<p class="warn">${output}</p>`;
            if (autoScrollEnabled) {
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            originalConsoleWarn(...args); // Optionally log to the original console
        };

        // Package management
        const packages = {
            used: {},
            unused: {}
        };

        function extractPackageName(url) {
            const parts = url.split('/');
            return parts[parts.length - 1];
        }

        function installPackage(command) {
            const args = command.split(' ');
            const packageUrl = args[args.length - 1]; // 假设最后一个参数是包的 URL

            if (!packageUrl) {
                console.error("Usage: jpm install <package-url>");
                return;
            }

            const packageName = extractPackageName(packageUrl);

            console.log(`Starting installation of package from ${packageUrl}`);
            console.log(`Downloading package from ${packageUrl}`);

            // Show progress bar
            let progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.innerHTML = `[================>          ] 0%`;
            consoleOutput.appendChild(progressBar);

            fetch(packageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const totalSize = blob.size;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const scriptContent = event.target.result;
                        const script = document.createElement('script');
                        script.textContent = scriptContent;
                        document.body.appendChild(script);
                        packages.used[packageName] = scriptContent;
                        console.log(`Package ${packageName} installed successfully.`);
                        // Save to file manager
                        const files = JSON.parse(localStorage.getItem('files') || '{}');
                        files[packageName] = scriptContent;
                        localStorage.setItem('files', JSON.stringify(files));
                        loadFiles();
                    };
                    reader.onprogress = function(event) {
                        if (event.lengthComputable) {
                            const progress = (event.loaded / totalSize) * 100;
                            progressBar.innerHTML = `[${'='.repeat(Math.floor(progress / 10))}>${' '.repeat(10 - Math.floor(progress / 10))}] ${progress.toFixed(2)}%`;
                        }
                    };
                    reader.readAsText(blob);
                })
                .catch(error => {
                    console.error(`Failed to install package from ${packageUrl}: ${error.message}`);
                });
        }

        function mountPackage(command) {
            const args = command.split(' ');
            const packageUrl = args[args.length - 1]; // 假设最后一个参数是包的 URL

            if (!packageUrl) {
                console.error("Usage: jpm mount <package-url>");
                return;
            }

            const packageName = extractPackageName(packageUrl);

            console.log(`Starting mounting of package from ${packageUrl}`);
            console.log(`Mounting package from ${packageUrl}`);

            fetch(packageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(scriptContent => {
                    const script = document.createElement('script');
                    script.textContent = scriptContent;
                    document.body.appendChild(script);
                    packages.used[packageName] = scriptContent;
                    console.log(`Package ${packageName} mounted successfully.`);
                    // Save to file manager
                    const files = JSON.parse(localStorage.getItem('files') || '{}');
                    files[packageName] = scriptContent;
                    localStorage.setItem('files', JSON.stringify(files));
                    loadFiles();
                })
                .catch(error => {
                    console.error(`Failed to mount package from ${packageUrl}: ${error.message}`);
                });
        }

        function uninstallPackage(command) {
            const args = command.split(' ');
            const packageName = args[args.length - 1]; // 假设最后一个参数是包的名称

            if (!packageName) {
                console.error("Usage: jpm uninstall <package-name>");
                return;
            }

            if (packages.used[packageName]) {
                delete packages.used[packageName];
                console.log(`Package ${packageName} uninstalled successfully.`);
                // Remove from file manager
                const files = JSON.parse(localStorage.getItem('files') || '{}');
                delete files[packageName];
                localStorage.setItem('files', JSON.stringify(files));
                loadFiles();
            } else {
                console.error(`Package ${packageName} is not installed.`);
            }
        }

        function removePackage(command) {
            const args = command.split(' ');
            const packageName = args[args.length - 1]; // 假设最后一个参数是包的名称

            if (!packageName) {
                console.error("Usage: jpm remove <package-name>");
                return;
            }

            if (packages.used[packageName]) {
                delete packages.used[packageName];
                console.log(`Package ${packageName} removed successfully.`);
                // Remove from file manager
                const files = JSON.parse(localStorage.getItem('files') || '{}');
                delete files[packageName];
                localStorage.setItem('files', JSON.stringify(files));
                loadFiles();
            } else if (packages.unused[packageName]) {
                delete packages.unused[packageName];
                console.log(`Package ${packageName} removed successfully.`);
            } else {
                console.error(`Package ${packageName} does not exist.`);
            }
        }

        function listPackages(command) {
            const args = command.split(' ');
            const option = args[args.length - 1]; // 假设最后一个参数是选项

            if (option === '-u') {
                console.log("Used Packages:");
                for (const [name, content] of Object.entries(packages.used)) {
                    console.log(`- ${name}`);
                }
            } else if (option === '-nu') {
                console.log("Unused Packages:");
                for (const [name, content] of Object.entries(packages.unused)) {
                    console.log(`- ${name}`);
                }
            } else {
                console.log("All Packages:");
                console.log("Used Packages:");
                for (const [name, content] of Object.entries(packages.used)) {
                    console.log(`- ${name} (used)`);
                }
                console.log("Unused Packages:");
                for (const [name, content] of Object.entries(packages.unused)) {
                    console.log(`- ${name} (unused)`);
                }
            }
        }

        function executeCommand() {
            const command = commandInput.value.trim();
            if (!command) return;

            const [cmd, ...args] = command.split(' ');
            switch (cmd) {
                case 'jpm':
                    if (args[0] === 'install') {
                        installPackage(command); // 传递整个命令字符串
                    } else if (args[0] === 'mount') {
                        mountPackage(command); // 新增挂载逻辑
                    } else if (args[0] === 'uninstall') {
                        uninstallPackage(command);
                    } else if (args[0] === 'remove') {
                        removePackage(command);
                    } else if (args[0] === 'list') {
                        listPackages(command);
                    } else {
                        console.error(`Unknown jpm command: ${args[0]}`);
                    }
                    break;
                case 'read':
                    const fileName = args.join(' ');
                    if (!fileName) {
                        console.error("Usage: read <file-name>");
                        return;
                    }
                    const files = JSON.parse(localStorage.getItem('files') || '{}');
                    if (files[fileName]) {
                        editor.textContent = files[fileName];
                    } else {
                        console.error(`File ${fileName} does not exist.`);
                    }
                    break;
                case 'save':
                    const saveFileName = args.join(' ');
                    if (!saveFileName) {
                        console.error("Usage: save <file-name>");
                        return;
                    }
                    const fileContent = editor.textContent.trim();
                    const saveFiles = JSON.parse(localStorage.getItem('files') || '{}');
                    saveFiles[saveFileName] = fileContent;
                    localStorage.setItem('files', JSON.stringify(saveFiles));
                    console.log(`File ${saveFileName} saved successfully.`);
                    loadFiles();
                    break;
                default:
                    try {
                        const result = eval(command);
                        if (result !== undefined) {
                            consoleOutput.innerHTML += `<p>&gt; <code class="hljs">${hljs.highlight(command, { language: 'javascript' }).value}</code></p>`;
                            consoleOutput.innerHTML += `<p>${result}</p>`;
                        }
                    } catch (error) {
                        consoleOutput.innerHTML += `<p>&gt; <code class="hljs">${hljs.highlight(command, { language: 'javascript' }).value}</code></p>`;
                        consoleOutput.innerHTML += `<p class="error"><strong>Error:</strong> ${error.message}</p>`;
                    }
            }

            commandInput.value = '';
            commandInput.focus();
            hljs.highlightAll();
        }

        function executeEditorScript() {
            const scriptContent = editor.textContent.trim();
            if (!scriptContent) {
                console.error("No script to execute.");
                return;
            }

            try {
                const result = eval(scriptContent);
                if (result !== undefined) {
                    consoleOutput.innerHTML += `<p>&gt; <code class="hljs">${hljs.highlight(scriptContent, { language: 'javascript' }).value}</code></p>`;
                    consoleOutput.innerHTML += `<p>${result}</p>`;
                }
            } catch (error) {
                consoleOutput.innerHTML += `<p>&gt; <code class="hljs">${hljs.highlight(scriptContent, { language: 'javascript' }).value}</code></p>`;
                consoleOutput.innerHTML += `<p class="error"><strong>Error:</strong> ${error.message}</p>`;
            }
        }

        function toggleAutoScroll() {
            autoScrollEnabled = !autoScrollEnabled;
            autoScrollToggle.textContent = autoScrollEnabled ? 'Disable Auto Scroll' : 'Enable Auto Scroll';
        }

        // 文件管理器功能
        function openFileManager() {
            loadFiles();
            fileManagerModal.style.display = 'block';
        }

        function closeFileManager() {
            fileManagerModal.style.display = 'none';
        }

        function openCreateFileModal() {
            createFileModal.style.display = 'block';
        }

        function closeCreateFileModal() {
            createFileModal.style.display = 'none';
        }

        function openCreateFolderModal() {
            createFolderModal.style.display = 'block';
        }

        function closeCreateFolderModal() {
            createFolderModal.style.display = 'none';
        }

        function loadFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            const files = JSON.parse(localStorage.getItem('files') || '{}');
            for (const fileName in files) {
                const fileContent = files[fileName];
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>${fileName}</span>
                    <button onclick="editFile('${fileName}')">Edit</button>
                    <button onclick="deleteFile('${fileName}')">Delete</button>
                `;
                fileList.appendChild(listItem);
            }
        }

        function createFile() {
            const fileName = document.getElementById('newFileName').value;
            const fileContent = document.getElementById('newFileContent').value;
            if (!fileName) {
                alert('File name is required.');
                return;
            }
            const files = JSON.parse(localStorage.getItem('files') || '{}');
            files[fileName] = fileContent;
            localStorage.setItem('files', JSON.stringify(files));
            closeCreateFileModal();
            loadFiles();
        }

        function editFile(fileName) {
            const files = JSON.parse(localStorage.getItem('files') || '{}');
            const fileContent = files[fileName];
            document.getElementById('newFileName').value = fileName;
            document.getElementById('newFileContent').value = fileContent;
            openCreateFileModal();
        }

        function deleteFile(fileName) {
            const files = JSON.parse(localStorage.getItem('files') || '{}');
            delete files[fileName];
            localStorage.setItem('files', JSON.stringify(files));
            loadFiles();
        }

        function createFolder() {
            const folderName = document.getElementById('newFolderName').value;
            if (!folderName) {
                alert('Folder name is required.');
                return;
            }
            const files = JSON.parse(localStorage.getItem('files') || '{}');
            files[folderName] = {};
            localStorage.setItem('files', JSON.stringify(files));
            closeCreateFolderModal();
            loadFiles();
        }

        // Bind keyboard shortcut Ctrl+Enter or Command+Enter to run code
        commandInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                executeCommand();
                e.preventDefault();
            }
        });

        // 初始化时设置按钮文本
        autoScrollToggle.textContent = 'Disable Auto Scroll';
    </script>
</body>
</html>
